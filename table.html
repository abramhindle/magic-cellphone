
<!doctype html>
<html>
  <head>
    <title>Magic!</title>
    <style>
#multibuttonpanel {
        width: 100%;
       height: 25%;
}
#sliderpanel {
        width: 100%;
       height: 75%;
}


html, body {
   height: 100%;
   width: 100%;
   margin: 0;
   padding: 0;
}
</style>
    <script src="./gibberish3.js"></script>
  </head>
    <body>
    <div id="guis">
    </div>
    <script>

g = Gibberish.genish
Heaper = function(rhodes) {
    var heap = Gibberish.memory.heap
    this.instr = rhodes
    this.mem = rhodes.graph.inputs[0].data.memory
    let memory = this.mem
    this.idx = memory.values.idx
    this.len = memory.values.length
    let idx = this.idx
    let len = this.len
    this.buffer = heap.subarray(idx, idx + this.len) // new Float32Array( this.len )
    this.blit = function() {
        //let buffer = this.buffer
        //for ( var i = 0 ; i < len; i++ ) {
        //    heap[idx + i] = buffer[i]
        //}
    }
}

applyMem = function(heaper,f,start,range) {
    let buffer = heaper.buffer
    let len = heaper.len
    var max = Math.min(len,start+range);
    for( var i = Math.max(0,start); i < max; i++) {
        buffer[i] = f(i,buffer[i])
    }
    heaper.blit()
}
mulMem = function(heaper,x) {
    let buffer = heaper.buffer
    let len = heaper.len    
    for( var i = 0; i < len; i++) {
        buffer[i] *= x
    }
    heaper.blit()
}
addMem = function(heaper,x) {
    let heap = heaper.buffer
    let len = heaper.len    
    for( var i = 0; i < len; i++) {
        heap[i] += x
    }
    heaper.blit()
}
quantize = function(heaper,n) {
    applyMem(heaper,function(i,x) { return Math.round(x * n) / (1.0 * n)  },0,heaper.len);
}
identity = function(heaper) {
    applyMem(heaper,function(i,x) { return x },0,len)
}
clamp = function(heaper,low,high) {
    applyMem(heaper,function(i,x) { return Math.min(high,Math.max(low,x)) },0,heaper.len); 
}
noise = function(heaper,coef) {
    applyMem(heaper,function(i,x) { return coef*Math.random() },0,heaper.len); 
}
zero = function(heaper) {
    let heap = heaper.buffer
    let len = heaper.len    
    for( var i = 0; i < len; i++) {
        heap[i] = 0.0;
    }
    heaper.blit()
}
meanNeighbor = function(heaper) {
    let heap = heaper.buffer
    let len = heaper.len    
    for( var i = 1; i < len-1; i++) {
        heap[i] = (heap[i - 1] + heap[i] + heap[i + 1])/3.0;
    }
    heaper.blit()
}
    
noiseInjector = function(heaper,chance) {
    let heap = heaper.buffer
    let len = heaper.len
    console.log(heap)
    for( var i = 0; i < len; i++) {
        if (Math.random() < chance) {
            heap[i] = 2.0*Math.random() - 1.0;
        }
    }
    heaper.blit()
}
    
    
pasteRegion = function(heaper,n) {
    let heap = heaper.buffer
    let len = heaper.len    
    var start = Math.round(Math.random()*len)
    var newstart = Math.round(Math.random()*len)
    for (var i = 0; i < n; i++) {
     	if ((newstart + i) < len && (start + i) < len) {
            heap[newstart + i] = heap[start + i] 
        }
    }
    heaper.blit()
}


pasteRepeatRegion = function(heaper,n) {
    let heap = heaper.buffer
    let len = heaper.len    
    var start = Math.round(Math.random()*len)
    var newstart = Math.round(Math.random()*len)
    var tmp = new Float32Array( n )
    for (var i = 0; i < n; i++) {
        tmp[i] = heap[(start  + i)%len] 
    }
    for (var i = 0; i < len; i++) {
        heap[i] = tmp[i % tmp.length]
    }
    heaper.blit()
}




window.addEventListener("load", function() {
    console.log("onload");
    Gibberish.init();
    n = 1024

    heapers = [1,2,3,4,5].map( function(i) {    
        var orig = new Float32Array( n )
        var rhodes = Wavetable({ frequency: 440, buffer: orig  })
        rhodes.connect()
        console.log(rhodes)
        return new Heaper(rhodes)
    })
    console.log("ready");
    console.log(heapers);
    
    
    var decayerInterval = null
    decayer = function(heaper,decay) {
        if (decayerInterval === null) {
            decayerInterval = setInterval(function() {
                mulMem(heaper,decay)
            },100);
        } else {
            clearInterval(decayerInterval);
            decayerInterval = null
        }
    }

    changeFrequency = function(heaper,freq) {
        heaper.instr.frequency = parseFloat(freq)
        if (heaper.dom !== undefined) {
            heaper.dom.value = heaper.instr.frequency
        }
        console.log(heaper.instr.frequency)
    }

    
    funFunctions = [
        { "name":"low Freq", "fun":heaper => changeFrequency(heaper,20) },
        { "name":"Increase Freq", "fun":heaper => changeFrequency(heaper,1.1*heaper.instr.frequency) },
        { "name":"Decrease Freq", "fun":heaper => changeFrequency(heaper,0.9*heaper.instr.frequency) },
        { "name":"zero", "fun": heaper => mulMem(heaper,0)},
        { "name":"inject some noise", "fun":heaper => noiseInjector(heaper,0.001)},
        { "name":"inject more noise", "fun":heaper => noiseInjector(heaper,0.01)},
        { "name":"inject much noise", "fun":heaper => noiseInjector(heaper,0.1)},
        { "name":"paste little", "fun": heaper => pasteRegion(heaper,10)},
        { "name":"paste lots", "fun": heaper => pasteRegion(heaper,100)},
        { "name":"paste little repeat", "fun": heaper => pasteRepeatRegion(heaper,10)},
        { "name":"paste lots repeat", "fun": heaper => pasteRepeatRegion(heaper,100)},
        { "name":"mean neighbor", "fun": meanNeighbor},
        { "name":"clamp 0.1", "fun": heaper => clamp(heaper,-0.1,0.1)},
        { "name":"clamp 0.5", "fun": heaper => clamp(heaper,-0.5,0.5)},
        { "name":"* 0.5", "fun": heaper => mulMem(heaper,0.5)},
        { "name":"* 2", "fun": heaper => mulMem(heaper,2.0)},
        { "name":"+ 0.1", "fun": heaper => addMem(heaper,0.1)},
        { "name":"- 0.1", "fun": heaper => addMem(heaper,-0.1)}, 
        { "name":"+ 0.5", "fun": heaper => addMem(heaper,0.5)},
        { "name":"- 0.5", "fun": heaper => addMem(heaper,-0.5)},
        { "name":"Quantize 1024", "fun": heaper => quantize(heaper,1024)},
        { "name":"Quantize 256", "fun": heaper => quantize(heaper,256)},
        { "name":"Quantize 64", "fun": heaper => quantize(heaper,64)},
        { "name":"Quantize 16", "fun": heaper => quantize(heaper,16)},
        { "name":"Quantize 4", "fun": heaper => quantize(heaper,4)},
        { "name":"Quantize 2", "fun": heaper => quantize(heaper,2)},
        { "name":"Low Noise", "fun": heaper => noise(heaper,0.01)},
        { "name":"Med Noise", "fun": heaper => noise(heaper,0.1)},
        { "name":"High Noise", "fun": heaper => noise(heaper,0.9)},
        { "name":"Slow Decayer", "fun": heaper => decayer(heaper,0.999)},
        { "name":"Fast Decayer", "fun": heaper => decayer(heaper,0.99)},
    ]
    
    function mkHeaperGUI(heaper) {
        var div = document.createElement("div")
        var buttons = document.createElement("div")
        funFunctions.forEach(function(e) {
            var button = document.createElement("button")
            button.textContent = e.name
            button.addEventListener("click", function(evt) {  console.log(heaper); return e.fun(heaper) })            
            buttons.appendChild( button )
        })
        var frequencyDom = document.createElement("input")
        frequencyDom.type = "range"
        frequencyDom.min = 1
        frequencyDom.max = 1000
        frequencyDom.step = 1        
        frequencyDom.value = heaper.frequency
        heaper.dom = frequencyDom
        frequencyDom.addEventListener("change", function(e) {
            changeFrequency(heaper,frequencyDom.value)
        });
        div.appendChild(frequencyDom)
        div.appendChild(buttons)
        return div
    }
    
    guis = heapers.map( heaper => mkHeaperGUI(heaper) )
    guis.map( function(gui) {
        document.getElementById("guis").appendChild(gui)
    })
    
    
});
    
    </script>
  </body>
</html>

