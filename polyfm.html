<!doctype html>
<html>
  <head>
    <title>PolyFM</title>
    <link rel="manifest" href="/manifest.json">
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Magic Cellphone">
    <meta name="msapplication-TileImage" content="128x128.png">
    <meta name="msapplication-TileColor" content="#2F3BA2">

    <link rel="apple-touch-icon" href="128x128.png">

    <style>
      body {
        width: 100%;
        height: 100%;
        background: blue;
      }
#canvas {
        width: 100%;
        height: 100%;
}
#bigdiv {
        width: 100%;
        height: 100%;
}

      #runsum {
    color: white;
    position: absolute;
}
#sensitivity {
    position: absolute;
      }
   
</style>
    <script src="./gibberish3-c.js"></script>
    <script src="./performance.js"></script>

  </head>
    <body>
    <span id="runsum"></span>
    <input type="range" id="sensitivity" min="0" step="0.01" max="1.0"/>
    <div id="bigdiv">
      <canvas id="canvas">
      </canvas>
    </div>
    <script>
/* Some ideas were taken from

 * Mozilla https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia

*/
/* 
var width = 320;
var height = 240;
*/
var width = 320;
var height = 240;
var trigger = 0.5;

var constraints = {
    video: {
        frameRate: { ideal: 15, max: 30 },
        width: { min: height, ideal: width },
        height: { min: height, ideal: width },
        facingMode: "user" 
    }
};

var promise = navigator.mediaDevices.getUserMedia(constraints);
promise.then(function(mediaStream) {
    var video = document.createElement("video");
    //var video = document.querySelector('video');
    video.srcObject = mediaStream;
    video.onloadedmetadata = function(e) {
        video.play();
        video.volume = 0.0;
        startFrameDifferencer(video);
    };
})
.catch(function(err) { console.log(err.name + ": " + err.message); });


function playVideo() {
    var video = document.createElement("video");
    video.src = 'demo.mp4';
    video.volume = 0.0;
    video.loop = true;
    video.onloadedmetadata = function(e) {
        video.play();
        //video.volume = 0.0;
        startFrameDifferencer(video);
    };
    video.autoPlay = true;
}

//playVideo();

var dinterval;

var currentFrame = document.createElement("canvas");
var lastFrame    = document.createElement("canvas");
var callBack = null;


function startFrameDifferencer(video) {
    //var video = document.querySelector('video');
    //var runSumDom = document.getElementById('runsum');   
    var canvas = document.querySelector('canvas');
    var context = canvas.getContext('2d');
    var currentContext = currentFrame.getContext('2d');
    var lastContext = lastFrame.getContext('2d');
    dinterval = window.setInterval(function() {
        currentContext.drawImage(video,0,0,width,height);
        var outpix = context.getImageData(0,0,width,height);
        var current = currentContext.getImageData(0,0,width,height);
        var last    = lastContext.getImageData(0,0,width,height);
        var cd = current.data;
        var ld = last.data;
        var od = outpix.data;
        var mix = 0.5;
        var imix = 1.0 - mix;
        var cdc = 0;
        var ldc = 0;
        var o = 0;
        var runsum = 0;
        var diff;
        for (var i = 0 ; i < od.length ; i+=4) {
            ldc = ld[i+0] + ld[i+1] + ld[i + 2];
            cdc = cd[i+0] + cd[i+1] + cd[i + 2];
            diff = cdc - ldc;
            o = (od[i+2]*mix + imix * ( diff*diff>>9 )) % 255;
            od[i+0] = o;
            od[i+1] = o;
            od[i+2] = o;            
            od[i+3] = 255;
            runsum += o;
        }
        outpix.data = od;
        lastContext.putImageData(current,0,0);
        context.putImageData(outpix,0,0);
        //runSumDom.textContent = ""+runsum;
        if (callBack != null) {
            callBack(runsum,od);
        }
    },1000/(44100/4096));
}

// Boxes cuts the area into 64 boxes and then uses the callback
function boxes(runsum,od,callBack) {
    var b = new Array(64).fill(0);
    var x;
    var y;
    var nx;
    var ny;
    var pixels = od.length / 4;
    for (var i = 0; i < pixels ; i++) {
        x = i % width;
        y = Math.floor(i / width);
        nx = Math.floor(8.0 * x / width);
        ny = Math.floor(8.0 * y / height);
        b[nx + 8 * ny] += od[i*4+0];
    }
    if (callBack!=null) {
        return callBack(runsum,od,b);
    } else {
        return b;
    }
}

function colsum(arr,w,h) {
    var b = new Array(w).fill(0);
    for (var i = 0; i < w ; i++) {
        for (var j = 0; j < h ; j++) {
            b[i] += arr[w*j + i];
        }        
    }
    return b;
}

function rowsum(arr,w,h) {
    var b = new Array(h).fill(0);
    for (var i = 0; i < h ; i++) {
        for (var j = 0; j < w ; j++) {
            b[i] += arr[w*i + j];
        }        
    }
    return b;
}
function average(arr) {
    var bsum = arr.reduce((a,c) => a + c, 0);
    return bsum / arr.length;
}
function argmax(arr) {
    var x = arr[0];
    var xi = 0;
    for (var i = 1; i < arr.length; i++) {
        if (x < arr[i]) {
            xi = i;
            x = arr[i];
        }
    }
    return xi;
}
function maxi(arr) {
    var x = arr[0];
    var xi = 0;
    for (var i = 1; i < arr.length; i++) {
        if (x < arr[i]) {
            xi = i;
            x = arr[i];
        }
    }
    return [xi,x];
}

function metrics(runsum,od,callBack) {
    var b = boxes(runsum,od,null);
    var bcols = colsum(b,8,8);
    var brows = rowsum(b,8,8);
    var bsum = b.reduce((a,c) => a + c, 0);
    var bavg = bsum / b.length;
    var output = {
        boxes: b,
        sum: bsum,
        avg: bavg,
        cols: bcols,
        rows: brows,
        avgcols: average(bcols),
        avgrows: average(brows),
        maxcol: maxi(bcols),
        maxrow: maxi(brows)
    };
    //console.log(output.maxcol + " " + output.maxrow);
    if (callBack!=null) {
        return callBack(runsum,od,output);
    } else {
        return output;
    }
}

// Boxes cuts the area into 64 boxes and then uses the callback
function meansum(runsum,od,callBack) {
    var ms = 0.0;
    var x;
    var y;
    var nx;
    var ny;
    var pixels = od.length / 4;
    for (var i = 0; i < pixels ; i++) {
        x = i % width;
        y = Math.floor(i / width);
        nx = Math.floor(8.0 * x / width);
        ny = Math.floor(8.0 * y / height);
        ms += od[i*4+0];
    }
    ms /= 256*pixels;
    if (callBack!=null) {
        return callBack(runsum,od,ms);
    } else {
        return ms;
    }
}



function printBoxes(runsum,od,b) {
    for (var i = 0 ; i < b.length; i++) {
        if (b[i] >= trigger) {
            console.log(i+" "+b[i]);
        }
    }
}



window.addEventListener("load", function() {
    console.log("onload");
    var sensitivity = document.getElementById("sensitivity");
    sensitivity.value = trigger;
    sensitivity.addEventListener("change", function(e) {
        trigger = parseFloat(this.value);
        console.log(trigger);
    });
    Gibberish.init();


    bigfm = PolyFM({ 
        maxVoices:4,
        gain:.6, 
        cmRatio:4.01,
        index:0.5,
        carrierWaveform:'sine',
        modulatorWaveform:'triangle',
        attack:44100*4,
        decay:44100*10,
        feedback:.1,
        useADSR: true,
        triggerRelease: true,
    })

    dist = Distortion({ 
        input: bigfm,
        pregain:100,
        postgain:.25,
    })
    verb   = Freeverb({ roomSize:.95, damping:.15 })
    chorus = Chorus().connect( verb )
    dist.connect( chorus )
    Clamp(Merge(verb),-0.99,0.99).connect()
                        
    var state = "nothing";
    var mixit = function(runsum,od,metrics) {
        let mix = metrics["avg"] / 256.0
        //console.log(metrics);
        if (mix > trigger) {
            // console.log([mix,trigger]);
            let offset = 20 + 10*(metrics["maxcol"][0]);
            //console.log(metrics["maxcol"]);
            //console.log(metrics["cols"]);

            //if (state !== "triggered") {
            //var n = Math.random()
            var n = 100*metrics["maxcol"][0]/8.0;
            //var x = 100 + 100*Math.random();
            //console.log([n,x]);
            n = Math.random()*60
            bigfm.chord( [110/2+n,220/2+n,330/2+n,440/2+n] )
            bigfm.index = 0.5 + metrics["maxrow"][0]/8.0;
            state = "triggered";
            //console.log(state);
            //}
        } else {
            //if (state === "triggered") {
            //    syn.env.release();
            state = "advancing";
            //    console.log(state);
            //}
        }
    } 
    callBack = function(runsum,od) {
        metrics(runsum,od,mixit);
    };

    
});

checkAndInstallPerformance(120, "5.html");    

if('serviceWorker' in navigator) {
  navigator.serviceWorker
           .register('/sw.js')
           .then(function() { console.log("Service Worker Registered"); });
} else {
    console.log("No serviceWorker");
}

</script>

<style>
.button {
    display: inline-block;
    width: 30%;
    color: black;
    padding: 0.4em;
    background-color: white;
    border-color: black;
    border-style: solid;
}
.grey {
    background-color: grey;
}
</style>


<div width="100%">
	<a href="./1.html">
		<div class="button">
			Ocean
		</div>
	</a>
	<a href="./2.html">
		<div class="button grey">
			Delay
		</div>
	</a>
	<a href="./3.html">
		<div class="button">
			Plates
		</div>
	</a>
	<a href="./4.html">
		<div class="button grey">
			PolyFM
		</div>
	</a>
	<a href="./5.html">
		<div class="button">
			Ending
		</div>
	</a>
</div>
    
  </body>
</html>
